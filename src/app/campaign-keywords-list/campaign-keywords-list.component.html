<div class="keywords-list fancy-scrollbar">

  <mat-form-field
    color="accent"
    appearance="outline"
    class="search-field"
    *ngIf="isApiAvailable && !isGeneric && !(isLoading$ | async)">
    <mat-icon matPrefix>search</mat-icon>
    <input
      matInput
      #searchInput
      placeholder="Keywords search..."
      (keyup)="onInputChange($event)">
  </mat-form-field>

  <table mat-table
    [trackBy]="trackByFn"
    [dataSource]="keywords">
    <!-- Avatar Column -->
    <ng-container matColumnDef="avatar">
      <th class="avatar-column" mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef>
        <div class="avatar"></div>
      </td>
    </ng-container>

    <!-- Full keyword nName Column -->
    <ng-container matColumnDef="keyword-name">
      <th mat-header-cell *matHeaderCellDef>
        <span matTooltip="Search keyword phrase">
          Keyword
        </span>
      </th>
      <td mat-cell *matCellDef="let keyword">
        <mat-form-field>
          <input
            matInput
            [value]="keyword.name || ''"
            [maxLength]="maxNameLength"
            name="name"
            #keywordName
            (blur)="onKeywordEdit(keyword, { name: keywordName.value })"
            (keyup.enter)="onKeywordEdit(keyword, { name: keywordName.value })">
        </mat-form-field>
      </td>
    </ng-container>

    <!-- Search Volume Column -->
    <ng-container matColumnDef="search-volume">
      <th mat-header-cell *matHeaderCellDef>
        <span matTooltip="Estimated average monthly search volume">
          Search Vol.
        </span>
      </th>
      <td mat-cell *matCellDef="let keyword">
        <mat-form-field>
          <input
            matInput
            name="searchVolume"
            [value]="keyword.searchVolume"
            type="number"
            [min]="minSearchVolume"
            #searchVolume
            (blur)="setSearchVolume(keyword, { searchVolume: +searchVolume.value }, searchVolume)">
        </mat-form-field>
      </td>
    </ng-container>

    <ng-container matColumnDef="products">
      <th mat-header-cell *matHeaderCellDef>
        <span matTooltip="Selected products for this keyword's ad">
          Assigned Products
        </span>
      </th>
      <td mat-cell *matCellDef="let keyword">
        <div class="products-wrapper">
          <img
            class="product-avatar"
            src="../../assets/icons/icon-product.svg"
            *ngFor="let product of keyword.products"
            [matTooltip]="product.name"
            [class.priority]="product.priority">
          <button
            (click)="openAssignProductsDialog(keyword)"
            mat-mini-fab
            class="add-assigned-products">
            <mat-icon>{{ keyword.products.length ? 'edit' : 'add' }}</mat-icon>
          </button>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="arh">
      <th mat-header-cell *matHeaderCellDef>
        <span matTooltip="{{ 'Average Retail Health score of \n assigned products' }}">
          ARH
        </span>
      </th>
      <td mat-cell *matCellDef="let keyword">
        <div>{{ keyword.arh }}</div>
      </td>
    </ng-container>

    <!-- CTR Column -->
    <ng-container matColumnDef="ctr">
      <th mat-header-cell *matHeaderCellDef>
        <mat-icon
          #setCtrButton
          [class.active]="isCtrDialogOpened"
          class="set-default-ctr-icon"
          (click)="openCtrDialog()">add_circle</mat-icon>
        <span matTooltip="Estimated Click Through Rate">
          CTR
        </span>
      </th>
      <td mat-cell *matCellDef="let keyword">
        <mat-form-field>
          <input
            matInput
            [value]="keyword.ctr"
            lang="en-150"
            type="number"
            step="0.1"
            min="0"
            name="ctr"
            #ctr
            (blur)="setCTR(keyword, { ctr: ctr.value }, ctr)">
            <span matSuffix>%</span>
        </mat-form-field>
      </td>
    </ng-container>

    <!-- CPC Column -->
    <ng-container matColumnDef="cpc">
      <th mat-header-cell *matHeaderCellDef>
        <mat-icon
          #setCpcButton
          [class.active]="isCpcDialogOpened"
          class="set-default-ctr-icon"
          (click)="openCpcDialog()">add_circle</mat-icon>
        <span matTooltip="Estimated Cost Per Click">
          CPC
        </span>
      </th>
      <td mat-cell *matCellDef="let keyword">
        <div class="cpc-wrapper">
          <span class="currency-cell">{{ (currentCampaignCurrency$ | async)?.acronym }}</span>
          <mat-form-field>
            <input
              matInput
              [value]="keyword.cpc"
              name="cpc"
              type="number"
              step="0.01"
              min="0"
              #cpc
              (blur)="setCPC(keyword, { cpc: cpc.value }, cpc)">
          </mat-form-field>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="delete-button">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let keyword">
        <div class="delete-button-wrapper">
          <button mat-icon-button (click)="deleteKeyword(keyword.id)"><mat-icon>delete</mat-icon></button>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>
  <app-table-message-row
    message="Add first keyword"
    [clickable]="true"
    *ngIf="(keywords.length === 0) && !(isLoading$ | async)"
    (click)="openAddKeywordsDialog()">
  </app-table-message-row>
</div>

<div *ngIf="isCtrDialogOpened" class="default-value-dialog__bg" (click)="closeCtrDialog()">
  <div
    (click)="$event.stopPropagation()"
    class="default-value-dialog"
    [@enterAnimation]
    [style.top.px]="ctrDialogPosition.top + 25"
    [style.left.px]="ctrDialogPosition.left - 120 + (ctrDialogPosition.right - ctrDialogPosition.left) / 2">
    <p>Apply to all default CTR value</p>
    <div class="default-value-dialog__actions">
      <div>
        <mat-form-field appearance="outline" color="accent">
          <input
            matInput
            lang="en-150"
            type="number"
            step="0.1"
            [(ngModel)]="ctrDefaultValue"
            min="0">
        </mat-form-field>
        %
      </div>
      <button
        mat-raised-button
        (click)="setDefaultCtrValue()"
        color="accent">
        Apply
      </button>
    </div>
  </div>
</div>

<div *ngIf="isCpcDialogOpened" class="default-value-dialog__bg" (click)="closeCpcDialog()">
  <div
    (click)="$event.stopPropagation()"
    class="default-value-dialog"
    [@enterAnimation]
    [style.top.px]="cpcDialogPosition.top + 25"
    [style.left.px]="cpcDialogPosition.left - 120 + (cpcDialogPosition.right - cpcDialogPosition.left) / 2">
    <p>Apply to all default CPC value</p>
    <div class="default-value-dialog__actions">
      <div>
        <mat-form-field appearance="outline" color="accent">
          <input
            matInput
            lang="en-150"
            type="number"
            step="0.01"
            [(ngModel)]="cpcDefaultValue"
            min="0">
        </mat-form-field>
      </div>
      <button
        mat-raised-button
        (click)="setDefaultCpcValue()"
        color="accent">
        Apply
      </button>
    </div>
  </div>
</div>
