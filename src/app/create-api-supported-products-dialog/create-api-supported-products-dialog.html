<div mat-dialog-title>
  <h1>Add products</h1>

  <button
    class="mat-dialog-title__close-button"
    (click)="closeDialog()"
    matTooltip="Close dialog"
    aria-label="...">
    <mat-icon
      aria-label="Close">
      close
    </mat-icon>
  </button>
</div>

<div mat-dialog-content>
  <div class="product-input__wrapper">
    <mat-form-field appearance="outline" color="accent" class="product-input">
      <input
        matInput
        #asinsInput
        (keyup.enter)="addProductByInput(asinsInput.value); asinsInput.value = ''"
        (paste)="paste($event)"
        placeholder="Type ASIN codes or paste asins column from excel here">
    </mat-form-field>
    <button
      mat-raised-button
      color="accent"
      class="product-input__button"
      [class.active]="asinsInput.value"
      [disabled]="!asinsInput.value"
      (click)="addProductByInput(asinsInput.value); asinsInput.value = ''">
      Add
    </button>
  </div>

  <div class="product-list" *ngIf="errorMessage">
    <label class="chosen-products-label error">{{ errorMessage }}</label>
  </div>

  <div
    class="products-list"
    id="list-table"
    *ngIf="products.length">
    <label class="chosen-products-label" for="list-table">List of loaded products: ({{counter}})</label>
    <table mat-table [trackBy]="trackByFn" [dataSource]="products">

      <!-- Full product name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>
          <span>
            Product name
          </span>
        </th>
        <td 
          mat-cell 
          *matCellDef="let product" 
          [ngClass]="{'row-warning': checkForWarning(product), 'row-error': checkForError(product)}">
          <ng-container *ngIf="product.state !== apiProductStates.LOADED">
            <mat-spinner
              diameter="30"
              strokeWidth="2"
              color="accent">
            </mat-spinner>
          </ng-container>
          <ng-container *ngIf="product.state === apiProductStates.LOADED">
            {{ checkForError(product) ? 'Product with this ASIN is not available.' : product.name }}
          </ng-container>
        </td>
      </ng-container>

      <!-- ASIN Column -->
      <ng-container matColumnDef="asin">
        <th mat-header-cell *matHeaderCellDef>
          <span>
            ASIN
          </span>
        </th>
        <td 
          mat-cell 
          *matCellDef="let product" 
          [ngClass]="{'row-warning': checkForWarning(product), 'row-error': checkForError(product)}">
          {{ product.asin }}
        </td>
      </ng-container>

      <!-- Retail Health Column -->
      <ng-container matColumnDef="retailHealth">
        <th mat-header-cell *matHeaderCellDef>
          <span>
            RH
          </span>
        </th>
        <td 
          mat-cell 
          *matCellDef="let product" 
          [ngClass]="{'row-warning': checkForWarning(product), 'row-error': checkForError(product)}">
          <div class="rh-wrapper">
            <span>{{ product.retailHealth || '-'}}</span>
          </div>
        </td>
      </ng-container>
      
      <!-- Errors Column -->
      <ng-container matColumnDef="errors">
        <th mat-header-cell *matHeaderCellDef>
          <span>
            Errors
          </span>
        </th>
        <td 
          mat-cell 
          *matCellDef="let product" 
          [ngClass]="{'row-warning': checkForWarning(product), 'row-error': checkForError(product)}">
          <div class="warning-wrapper" *ngIf="product.state === apiProductStates.LOADED && checkForWarning(product)">
            <mat-icon
              svgIcon="warning"
              matTooltip="Warning Some data is missing, try to refresh."
              matTooltipPosition="above">
            </mat-icon>
            <button mat-icon-button (click)="refreshProduct(product)">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
          
          <div class="warning-wrapper" *ngIf="checkForError(product)" >
            <mat-icon svgIcon="red_warning" 
              matTooltip="Warning There is a problem with the ASIN code."
              matTooltipPosition="above">
            </mat-icon>
          </div>
        </td>
      </ng-container>

      <!-- Delete Button Column -->
      <ng-container matColumnDef="delete-button">
        <th mat-header-cell *matHeaderCellDef></th>
        <td 
          mat-cell 
          *matCellDef="let product" 
          [ngClass]="{'row-warning': checkForWarning(product), 'row-error': checkForError(product)}">
          <div
            class="delete-button-wrapper"
            *ngIf="product.state !== apiProductStates.REQUESTED">
            <button mat-icon-button (click)="deleteProduct(product.asin)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        [ngClass]="{ 'row-requested': row.state === apiProductStates.REQUESTED }">
      </tr>
    </table>
  </div>

  <div
    class="product-list"
    id="excel-mockup"
    *ngIf="!products.length">
    <label class="chosen-products-label" for="excel-mockup">
      You may select range of <span class="bold">ASIN cells</span> from your Excel file and paste it in area above.
      <br>
      Remember to define and select header exactly like on given example.
    </label>
    <img src="/assets/images/shelfspend_api_supported_product_excel_mockup.svg" alt="Mockup excel">
  </div>
</div>

<div mat-dialog-actions>
  <div class="button-field-wrapper">
    <button
      mat-stroked-button
      color="primary"
      (click)="closeDialog()">
      Cancel
    </button>
  </div>
  <div class="button-field-wrapper action-buttons">
    <span>Save loaded products as a (choose one):</span>
    <div>
      <button
        mat-raised-button
        (click)="submitForm(productTypes.BRAND)"
        [disabled]="!products.length"
        color="accent">
        Brand
      </button>
      <button
        mat-raised-button
        (click)="submitForm(productTypes.COMPETITOR)"
        [disabled]="!products.length"
        color="accent">
        Competitor
      </button>
    </div>
  </div>
</div>
